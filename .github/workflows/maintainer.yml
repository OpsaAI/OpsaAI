name: Maintainer Automation

on:
  schedule:
    # Run daily at 9 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '10'

jobs:
  daily-maintenance:
    name: Daily Maintenance Tasks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        uses: actions/github-script@v7
        with:
          script: |
            // Get repository statistics
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            // Get open issues count
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 1
            });

            // Get open PRs count
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 1
            });

            // Get recent activity
            const { data: recentIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              sort: 'updated',
              per_page: 5
            });

            console.log('ðŸ“Š Repository Statistics:');
            console.log(`   Stars: ${repo.stargazers_count}`);
            console.log(`   Forks: ${repo.forks_count}`);
            console.log(`   Open Issues: ${issues.length > 0 ? issues[0].number : 0}`);
            console.log(`   Open PRs: ${prs.length > 0 ? prs[0].number : 0}`);
            console.log(`   Total Issues: ${repo.open_issues_count}`);
            
            console.log('\nðŸ”„ Recent Activity:');
            recentIssues.forEach(issue => {
              const type = issue.pull_request ? 'PR' : 'Issue';
              const status = issue.state === 'open' ? 'ðŸŸ¢' : 'ðŸ”´';
              console.log(`   ${status} ${type} #${issue.number}: ${issue.title}`);
            });

      - name: Check for stale issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: staleIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'stale',
              per_page: 10
            });

            if (staleIssues.length > 0) {
              console.log(`âš ï¸ Found ${staleIssues.length} stale issues that may need attention:`);
              staleIssues.forEach(issue => {
                console.log(`   - #${issue.number}: ${issue.title}`);
              });
            } else {
              console.log('âœ… No stale issues found');
            }

      - name: Check for unlabeled issues
        uses: actions/github-script@v7
        with:
          script: |
            const { data: unlabeledIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 20
            });

            const unlabeled = unlabeledIssues.filter(issue => 
              !issue.pull_request && issue.labels.length === 0
            );

            if (unlabeled.length > 0) {
              console.log(`ðŸ·ï¸ Found ${unlabeled.length} unlabeled issues:`);
              unlabeled.forEach(issue => {
                console.log(`   - #${issue.number}: ${issue.title}`);
              });
            } else {
              console.log('âœ… All issues are properly labeled');
            }

      - name: Check Dependabot PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { data: dependabotPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              per_page: 10
            });

            const dependabot = dependabotPRs.filter(pr => 
              pr.user.login === 'dependabot[bot]'
            );

            if (dependabot.length > 0) {
              console.log(`ðŸ“¦ Found ${dependabot.length} Dependabot PRs:`);
              dependabot.forEach(pr => {
                console.log(`   - #${pr.number}: ${pr.title}`);
              });
            } else {
              console.log('âœ… No pending Dependabot PRs');
            }

  weekly-summary:
    name: Weekly Summary
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1'  # Only on Mondays
    steps:
      - name: Generate Weekly Summary
        uses: actions/github-script@v7
        with:
          script: |
            // Get weekly statistics
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

            const { data: recentIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              since: oneWeekAgo.toISOString(),
              per_page: 100
            });

            const { data: recentPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100
            });

            const newIssues = recentIssues.filter(issue => 
              !issue.pull_request && new Date(issue.created_at) > oneWeekAgo
            );

            const closedIssues = recentIssues.filter(issue => 
              !issue.pull_request && issue.state === 'closed' && 
              new Date(issue.closed_at) > oneWeekAgo
            );

            const mergedPRs = recentPRs.filter(pr => 
              pr.merged_at && new Date(pr.merged_at) > oneWeekAgo
            );

            console.log('ðŸ“ˆ Weekly Summary:');
            console.log(`   New Issues: ${newIssues.length}`);
            console.log(`   Closed Issues: ${closedIssues.length}`);
            console.log(`   Merged PRs: ${mergedPRs.length}`);
            console.log(`   Total Activity: ${recentIssues.length + recentPRs.length}`);

            // Create a summary comment (optional)
            if (newIssues.length > 0 || mergedPRs.length > 0) {
              const summary = `## ðŸ“ˆ Weekly Summary (${new Date().toLocaleDateString()})
              
              **Activity:**
              - ðŸ†• New Issues: ${newIssues.length}
              - âœ… Closed Issues: ${closedIssues.length}
              - ðŸ”€ Merged PRs: ${mergedPRs.length}
              
              **Top Contributors:**
              ${mergedPRs.slice(0, 5).map(pr => `- @${pr.user.login}`).join('\n')}
              
              Thanks to all contributors! ðŸŽ‰`;

              console.log('Weekly summary generated');
            }
